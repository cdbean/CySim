Core algorithm for map rendering
